{"version":3,"sources":["../../../../src/commands/run/ios/resolveDeviceAsync.ts"],"names":["getSimulatorsAsync","simulatorDeviceInfo","SimControl","listAsync","Object","values","devices","reduce","prev","runtime","concat","getBuildDestinationsAsync","osType","listDevicesAsync","filter","device","deviceType","simulators","Simulator","sortDefaultDeviceToBeginningAsync","resolveDeviceAsync","ensureXcodeCommandLineToolsInstalledAsync","CommandError","simulator","ensureSimulatorOpenAsync","Log","debug","name","udid","spinner","chalk","cyan","start","catch","stop","value","type","limit","message","choices","map","item","isConnected","isActive","state","symbol","format","bold","text","title","osVersion","dim","suggest","input","regex","RegExp","choice","test","log","find","isSimulator","searchValue","toLowerCase","resolved"],"mappings":"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","sourcesContent":["import chalk from 'chalk';\nimport { SimControl, Simulator } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport prompt from '../../../prompts';\nimport { ora } from '../../../utils/ora';\nimport { profileMethod } from '../../utils/profileMethod';\n\nasync function getSimulatorsAsync(): Promise<SimControl.SimulatorDevice[]> {\n  const simulatorDeviceInfo = await SimControl.listAsync('devices');\n  return Object.values(simulatorDeviceInfo.devices).reduce((prev, runtime) => {\n    return prev.concat(runtime);\n  }, []);\n}\n\nasync function getBuildDestinationsAsync({ osType }: { osType?: string } = {}) {\n  const devices = (\n    await profileMethod(SimControl.listDevicesAsync, 'SimControl.listDevicesAsync')()\n  ).filter(device => {\n    return device.deviceType === 'device';\n  });\n\n  const simulators = await Simulator.sortDefaultDeviceToBeginningAsync(\n    await profileMethod(getSimulatorsAsync)(),\n    osType\n  );\n\n  return [...devices, ...simulators];\n}\n\nexport async function resolveDeviceAsync(\n  device?: string | boolean,\n  { osType }: { osType?: string } = {}\n): Promise<SimControl.SimulatorDevice | SimControl.XCTraceDevice> {\n  if (!(await profileMethod(Simulator.ensureXcodeCommandLineToolsInstalledAsync)())) {\n    throw new CommandError('Unable to verify Xcode and Simulator installation.');\n  }\n\n  if (!device) {\n    const simulator = await profileMethod(\n      Simulator.ensureSimulatorOpenAsync,\n      'Simulator.ensureSimulatorOpenAsync'\n    )({ osType });\n    Log.debug(`Resolved default (${osType}) device:`, simulator.name, simulator.udid);\n    return simulator;\n  }\n\n  const spinner = ora(\n    `🔍 Finding ${device === true ? 'devices' : `device ${chalk.cyan(device)}`}`\n  ).start();\n  let devices: (\n    | SimControl.SimulatorDevice\n    | SimControl.XCTraceDevice\n  )[] = await getBuildDestinationsAsync({ osType }).catch(() => []);\n\n  spinner.stop();\n\n  if (device === true) {\n    // If osType is defined, then filter out ineligible simulators.\n    // Only do this inside of the device selection so users who pass the entire device udid can attempt to select any simulator (even if it's invalid).\n    if (osType) {\n      devices = devices.filter(device => {\n        // connected device\n        if (!('osType' in device)) {\n          return true;\n        }\n        return device.osType === osType;\n      });\n    }\n\n    // --device with no props after\n    const { value } = await prompt({\n      type: 'autocomplete',\n      name: 'value',\n      limit: 11,\n      message: 'Select a simulator',\n      choices: devices.map(item => {\n        const isConnected = 'deviceType' in item;\n        const isActive = 'state' in item && item.state === 'Booted';\n        const symbol = isConnected ? '🔌 ' : '';\n        const format = isActive ? chalk.bold : (text: string) => text;\n        return {\n          title: `${symbol}${format(item.name)}${\n            item.osVersion ? chalk.dim(` (${item.osVersion})`) : ''\n          }`,\n          value: item.udid,\n        };\n      }),\n      suggest: (input: any, choices: any) => {\n        const regex = new RegExp(input, 'i');\n        return choices.filter((choice: any) => regex.test(choice.title));\n      },\n    });\n    Log.log(chalk.dim`\\u203A Using --device ${value}`);\n    const device = devices.find(device => device.udid === value)!;\n    const isSimulator = !('deviceType' in device);\n    if (isSimulator) {\n      return await Simulator.ensureSimulatorOpenAsync({ udid: device.udid });\n    }\n    return device;\n  }\n  const searchValue = device.toLowerCase();\n  const resolved = devices.find(device => {\n    return device.udid.toLowerCase() === searchValue || device.name.toLowerCase() === searchValue;\n  });\n\n  if (!resolved) {\n    throw new CommandError(`No device UDID or name matching \"${device}\"`);\n  }\n\n  const isSimulator = !('deviceType' in resolved);\n  if (isSimulator) {\n    return await Simulator.ensureSimulatorOpenAsync({ udid: resolved.udid });\n  }\n\n  return resolved;\n}\n"],"file":"resolveDeviceAsync.js"}